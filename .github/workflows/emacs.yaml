name: Build Emacs
on:
  schedule:
    - cron: '0 0 * * *'
      
jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout emacs source
        uses: actions/checkout@v2
        with:
          repository: emacs-mirror/emacs
          ref: master
      - name: Install Nix
        uses: cachix/install-nix-action@v13
      - name: Install cachix
        run: nix-env -iA cachix -f https://cachix.org/api/v1/install
      - name: Use nix-emacs-ci binaries
        run: cachix use nix-emacs-ci 
      - name: Build Emacs for macOS
        run: curl https://raw.githubusercontent.com/jimeh/build-emacs-for-macos/master/build-emacs | bash /dev/stdin --git-sha HEAD --git-tag nightly --no-upload --no-notarize --no-dmg --zip-only 
      - name: Create release
        id: create_release
        uses: actions/create-release@v1.1.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: nightly-${{ github.run_number }}
          release_name: Nightly Build ${{ github.run_number }}
          draft: false
          prerelease: true
      - name: Upload Release Asset # This step uploads the zip file created earlier as an asset for the release created above.
        id: upload-release-asset 
        uses: actions/upload-release-asset@v1.0.2 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        with:
          upload_url:${{ steps.create_release.outputs.upload_url }}
          asset_path:${{ github.workspace }}/result.zip
          asset_name:result.zip
          asset_content_type:'application/zip'
